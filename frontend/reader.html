<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading - Nightmare Library</title>
    <link rel="icon" href="/frontend/assets/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/frontend/styles/reader.css">
</head>
<body class="theme-obsidian">
    <!-- Loading State -->
    <div class="reader-loading" id="reader-loading">
        <div class="reader-loading-spinner"></div>
        <p class="reader-loading-text">Loading book...</p>
    </div>

    <!-- Error State -->
    <div class="reader-error" id="reader-error" style="display: none;">
        <div class="reader-error-icon">&#9888;</div>
        <h2 class="reader-error-title">Failed to load book</h2>
        <p class="reader-error-text" id="error-message">An error occurred while loading the book.</p>
        <button class="btn btn-primary" onclick="window.location.href='/frontend/dashboard.html'">Back to Library</button>
    </div>

    <div class="reader-container" id="reader-container" style="display: none;">
        <!-- Header -->
        <header class="reader-header" id="reader-header">
            <div class="reader-header-left">
                <button class="back-btn" id="back-btn" title="Back to library (L)">
                    &#8592;
                </button>
                <h1 class="reader-title" id="book-title">Loading...</h1>
            </div>

            <div class="reader-header-center">
                <div class="reader-progress-bar">
                    <div class="reader-progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <span class="reader-progress-text" id="progress-text">0%</span>
            </div>

            <div class="reader-header-right">
                <div class="font-controls">
                    <button class="font-btn" id="font-decrease" title="Decrease font size">A-</button>
                    <button class="font-btn" id="font-increase" title="Increase font size">A+</button>
                </div>

                <div class="theme-selector">
                    <button class="theme-btn obsidian active" data-theme="obsidian" title="Dark theme"></button>
                    <button class="theme-btn sepia" data-theme="sepia" title="Sepia theme"></button>
                    <button class="theme-btn light" data-theme="light" title="Light theme"></button>
                </div>

                <button class="reader-btn" id="toc-btn" title="Table of contents">
                    &#9776;
                </button>

                <button class="reader-btn" id="fullscreen-btn" title="Fullscreen (F)">
                    &#x26F6;
                </button>
            </div>
        </header>

        <!-- Table of Contents Sidebar -->
        <div class="toc-overlay" id="toc-overlay"></div>
        <aside class="toc-sidebar" id="toc-sidebar">
            <div class="toc-header">
                <h2 class="toc-title">Contents</h2>
                <button class="toc-close" id="toc-close">&times;</button>
            </div>
            <nav class="toc-list" id="toc-list">
                <!-- TOC items loaded dynamically -->
            </nav>
        </aside>

        <!-- Reader Content -->
        <div class="reader-content" id="reader-content">
            <!-- EPUB container -->
            <div class="epub-container" id="epub-container"></div>

            <!-- PDF container -->
            <div class="pdf-container" id="pdf-container" style="display: none;">
                <canvas id="pdf-canvas"></canvas>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="reader-nav" id="reader-nav">
            <button class="nav-btn" id="prev-btn" title="Previous (J)">
                <span>&#8592;</span>
                <span>Previous</span>
            </button>

            <span class="page-indicator" id="page-indicator">Page 1</span>

            <button class="nav-btn" id="next-btn" title="Next (K)">
                <span>Next</span>
                <span>&#8594;</span>
            </button>
        </nav>

        <!-- Progress Ring -->
        <div class="reader-progress-ring" id="progress-ring">
            <svg viewBox="0 0 36 36">
                <defs>
                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#bb86fc"/>
                        <stop offset="100%" style="stop-color:#7c4dff"/>
                    </linearGradient>
                </defs>
                <circle class="bg" cx="18" cy="18" r="16"/>
                <circle class="progress" cx="18" cy="18" r="16"
                        stroke-dasharray="0, 100" id="progress-circle"/>
                <text class="text" x="18" y="18" id="progress-ring-text">0%</text>
            </svg>
        </div>

        <!-- Keyboard Shortcuts Hint -->
        <div class="shortcuts-hint" id="shortcuts-hint">
            <kbd>J</kbd> Previous &nbsp;
            <kbd>K</kbd> Next &nbsp;
            <kbd>F</kbd> Fullscreen &nbsp;
            <kbd>L</kbd> Library
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js" integrity="sha384-3XVHiS3Z4lBv0XEEshQfHhFEDO4C+UKCWoEwNb4RVkbhJkkfvp8C4l4E9xZYmhcl+" crossorigin="anonymous"></script>
    <!-- pdf.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js" integrity="sha384-IQVVVDNK72iFv7BKnSDGvz6dNr3DQVQC7RJXxXLg0Y6vc1V7zNEpBpYfKaQ63hZf" crossorigin="anonymous"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
        // Disable CORS for pdf.js worker
        pdfjsLib.GlobalWorkerOptions.disableWorker = false;
    </script>
    <script type="module" src="/frontend/scripts/dom-helpers.js"></script>
    <script src="/frontend/scripts/tts-engine.js"></script>
    <script type="module" src="/frontend/scripts/emoji-bookmarks.js"></script>
    <script type="module" src="/frontend/scripts/reading-gamification.js"></script>
    <script type="module" src="/frontend/scripts/reader.js"></script>
</body>
</html>